# Habana Labs hlml plugin
Enables autodetect for habana labs devices

### Compile and install on a new server
* Create environment:
  ```
  groupadd -g 64030 slurm
  useradd -u 64030 -g slurm --system --no-create-home slurm
  mkdir /etc/slurm /var/log/slurm /var/spool/slurmd /var/spool/slurmctld
  chown slurm:slurm /var/log/slurm /var/spool/slurmd /var/spool/slurmctld
  apt install munge libmunge-dev libglib2.0-dev libdbus-1-dev -y
  echo 'export PATH=$PATH:/usr/local/slurm/bin' >> /etc/profile.d/slurm.sh
  source /etc/profile.d/slurm.sh
  echo '/usr/lib/habanalabs' > /etc/ld.so.conf.d/habanalabs.conf
  ldconfig
  ```
* Copy conf files:
	* /etc/slurm/slurm.conf
	  ```
	  # slurm.conf file generated by configurator.html.
	  # Put this file on all nodes of your cluster.
	  # See the slurm.conf man page for more information.
	  #
	  ClusterName=cluster
	  SlurmctldHost=CONTROLLER_HOSTNAME
	  #SlurmctldHost=SECOND_CONTROLLER_HOSTNAME (Optional - fallback controller node)
	  ProctrackType=proctrack/cgroup
	  ReturnToService=1
	  SlurmctldPidFile=/var/run/slurmctld.pid
	  SlurmctldPort=6817
	  SlurmdPidFile=/var/run/slurmd.pid
	  SlurmdPort=6818
	  SlurmdSpoolDir=/var/spool/slurmd
	  SlurmUser=slurm
	  StateSaveLocation=/var/spool/slurmctld
	  TaskPlugin=task/affinity,task/cgroup

	  # TIMERS
	  InactiveLimit=0
	  KillWait=30
	  MinJobAge=300
	  SlurmctldTimeout=120
	  SlurmdTimeout=300
	  Waittime=0

	  # SCHEDULING
	  SchedulerType=sched/backfill
	  SelectType=select/cons_tres

	  # LOGGING AND ACCOUNTING
	  JobCompType=jobcomp/none
	  JobAcctGatherFrequency=30
	  SlurmctldDebug=info
	  SlurmctldLogFile=/var/log/slurm/slurmctld.log
	  SlurmdDebug=info
	  SlurmdLogFile=/var/log/slurm/slurmd.log

	  # COMPUTE NODES
	  GresTypes=gpu
	  NodeName=HOSTNAME CPUs=n_CPUs RealMemory=n_RealMemoryInMB Sockets=n_Sockets CoresPerSocket=n_CoresPerSocket ThreadsPerCore=n_ThreadsPerCore State=UNKNOWN Gres=gpu:s_CardType:n_CardsNumber # Specifying the card type is not necessary as is it discover automatically, Gres=gpu:n_CardsNumber will work as well
	  PartitionName=default Nodes=ALL Default=YES MaxTime=INFINITE State=UP
	  ```
	  > generated using https://slurm.schedmd.com/configurator.html
	* /etc/slurm/gres.conf
	  ```
	  ##################################################################
	  # Slurm's Generic Resource (GRES) configuration file
	  # Define Habana devices
	  ##################################################################
	  AutoDetect=hlml
	  ```
	* /etc/slurm/cgroup.conf
	  ```
	  CgroupMountpoint=/sys/fs/cgroup

	  ConstrainCores=yes
	  ConstrainDevices=yes
	  ConstrainRAMSpace=yes
	  ```
* Compile SLURMD and SLURMCTLD
	```
	cd /SLURM/CODE/DIRECTORY
	autoreconf
	./configure --prefix=/usr/local/slurm --sysconfdir=/etc/slurm --with-systemdsystemunitdir=/lib/systemd/system --with-hlml
	make
	make install
	```
	> Based on: https://slurm.schedmd.com/add.html#plugin
* Enable and start services
	```
	systemctl enable --now slurmctld.service # Only if the server is a control host
	systemctl enable --now slurmd.service
	```